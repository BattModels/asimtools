

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Developing Custom Asimmodules &mdash; asimtools 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=8d563738"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using built-in workflow tools" href="workflows.html" />
    <link rel="prev" title="Running an Existing Asimmodule" href="usage.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            asimtools
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="include_readme.html">README</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Running asimmodules</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Custom asimmodules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#build-and-test-with-a-cheap-calculator">1. Build and test with a cheap calculator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#wrap-in-a-function">2. Wrap in a function</a></li>
<li class="toctree-l2"><a class="reference internal" href="#make-the-asimmodule-use-any-calculator">3. Make the asimmodule use any calculator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#make-the-asimmodule-use-any-structure">4. Make the asimmodule use any structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#final-cleanup">5. Final cleanup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-multiple-simulations-in-a-workflow">6. Running multiple simulations in a workflow</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="include_contributing.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">asimtools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Developing Custom Asimmodules</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/asimplify.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="developing-custom-asimmodules">
<h1>Developing Custom Asimmodules<a class="headerlink" href="#developing-custom-asimmodules" title="Link to this heading"></a></h1>
<p>This section will guide you through taking your own in-house simulation and
integrating it into asimtools. The process is designed to be as
straight-forward as reasonably possible and with continued user-feedback we
hope to make it more seamless.</p>
<p>As an example, we will ASIMplify the calculation of equations of state as shown
in ASE. To understand the code, visit the ASE <a class="reference external" href="https://wiki.fysik.dtu.dk/ase/tutorials/db/db.html">tutorials page</a>.
Ultimately, the ASIMplified code will work with any chemical species, any
supported calculator and any configured computing environment with fully
parallelizable job submission on HPCs in just a few steps!</p>
<p>The code is given below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ase.build</span><span class="w"> </span><span class="kn">import</span> <span class="n">bulk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.calculators.emt</span><span class="w"> </span><span class="kn">import</span> <span class="n">EMT</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.eos</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_eos</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">connect</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="s1">&#39;bulk.db&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">symb</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Al&#39;</span><span class="p">,</span> <span class="s1">&#39;Ni&#39;</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">,</span> <span class="s1">&#39;Pd&#39;</span><span class="p">,</span> <span class="s1">&#39;Ag&#39;</span><span class="p">,</span> <span class="s1">&#39;Pt&#39;</span><span class="p">,</span> <span class="s1">&#39;Au&#39;</span><span class="p">]:</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">bulk</span><span class="p">(</span><span class="n">symb</span><span class="p">,</span> <span class="s1">&#39;fcc&#39;</span><span class="p">)</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">EMT</span><span class="p">()</span>
    <span class="n">eos</span> <span class="o">=</span> <span class="n">calculate_eos</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>  <span class="c1"># find minimum</span>
    <span class="c1"># Do one more calculation at the minimum and write to database:</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span> <span class="o">*=</span> <span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_volume</span><span class="p">())</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">bm</span><span class="o">=</span><span class="n">B</span><span class="p">)</span>
</pre></div>
</div>
<p>There are a couple of issues here that make it difficult to make this a
high-throughput calculation. First, because we directly setup the calculator in
the code, if we want to change the calculator we have to change the code. The
same applies for the structures and chosen chemical species. In addition, the
current code runs independent calculations one after the other. If each of
these calculations was an expensive calculation, it would be much less
efficient than running them in separate jobs on a HPC with a job scheduler. To
fix any of these issues, we would have to modify the code, job scripts and
perhaps even file structure. We will show how ASIMTools can help with all of
these issues. The end-result will be that any of these changes can made without
touching code or a job script.</p>
<section id="build-and-test-with-a-cheap-calculator">
<h2>1. Build and test with a cheap calculator<a class="headerlink" href="#build-and-test-with-a-cheap-calculator" title="Link to this heading"></a></h2>
<p>To make things easier, it is best to first replace the
expensive parts of your workflow with toy examples e.g. use an empirical
calculator like EMT instead of DFT, use a smaller/simpler structure, loop
over fewer cases etc.</p>
<p>The ASE example already uses a simple EMT calculator and simple structures.</p>
</section>
<section id="wrap-in-a-function">
<h2>2. Wrap in a function<a class="headerlink" href="#wrap-in-a-function" title="Link to this heading"></a></h2>
<p>The workhorse of ASIMTools is the asimmodule, any code
wrapped in a function that returns a dictionary can be run within the
ASIMTools framework. The easiest thing to do would be to take the code and
copy and paste it in a function which is defined inside an asimmodule with the
same name</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ase.build</span><span class="w"> </span><span class="kn">import</span> <span class="n">bulk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.calculators.emt</span><span class="w"> </span><span class="kn">import</span> <span class="n">EMT</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.eos</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_eos</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">connect</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ase_eos</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="s1">&#39;bulk.db&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">symb</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Al&#39;</span><span class="p">,</span> <span class="s1">&#39;Ni&#39;</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">,</span> <span class="s1">&#39;Pd&#39;</span><span class="p">,</span> <span class="s1">&#39;Ag&#39;</span><span class="p">,</span> <span class="s1">&#39;Pt&#39;</span><span class="p">,</span> <span class="s1">&#39;Au&#39;</span><span class="p">]:</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">bulk</span><span class="p">(</span><span class="n">symb</span><span class="p">,</span> <span class="s1">&#39;fcc&#39;</span><span class="p">)</span>
        <span class="n">atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">EMT</span><span class="p">()</span>
        <span class="n">eos</span> <span class="o">=</span> <span class="n">calculate_eos</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>  <span class="c1"># find minimum</span>
        <span class="c1"># Do one more calculation at the minimu and write to database:</span>
        <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span> <span class="o">*=</span> <span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_volume</span><span class="p">())</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">atoms</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">bm</span><span class="o">=</span><span class="n">B</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{}</span>
</pre></div>
</div>
<p>Immediately as it is, this is an asimmodule can be run in ASIMTools. You can
run it with the following sim_input.yaml</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">asimmodule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/ase_eos.py</span>
<span class="nt">env_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inline</span>
<span class="nt">workdir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">results</span>
</pre></div>
</div>
<p>then call</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">asim-execute sim_input.yaml</span>
</pre></div>
</div>
<p>Only a little bit more complicated than calling <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">ase_eos.py</span></code></p>
</section>
<section id="make-the-asimmodule-use-any-calculator">
<h2>3. Make the asimmodule use any calculator<a class="headerlink" href="#make-the-asimmodule-use-any-calculator" title="Link to this heading"></a></h2>
<p>This asimmodule however still depends on specific structures and a specific
calculator. Let’s do the easy thing first, let’s make the asimmodule work with any
calculator using a simple change.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ase.build</span><span class="w"> </span><span class="kn">import</span> <span class="n">bulk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.eos</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_eos</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">connect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">asimtools.calculators</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_calc</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ase_eos</span><span class="p">(</span>
    <span class="n">calc_id</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">load_calc</span><span class="p">(</span><span class="n">calc_id</span><span class="p">)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="s1">&#39;bulk.db&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">symb</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Al&#39;</span><span class="p">,</span> <span class="s1">&#39;Ni&#39;</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">,</span> <span class="s1">&#39;Pd&#39;</span><span class="p">,</span> <span class="s1">&#39;Ag&#39;</span><span class="p">,</span> <span class="s1">&#39;Pt&#39;</span><span class="p">,</span> <span class="s1">&#39;Au&#39;</span><span class="p">]:</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">bulk</span><span class="p">(</span><span class="n">symb</span><span class="p">,</span> <span class="s1">&#39;fcc&#39;</span><span class="p">)</span>
        <span class="n">atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">calc</span>
        <span class="n">eos</span> <span class="o">=</span> <span class="n">calculate_eos</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>  <span class="c1"># find minimum</span>
        <span class="c1"># Do one more calculation at the minimu and write to database:</span>
        <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span> <span class="o">*=</span> <span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_volume</span><span class="p">())</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">atoms</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">bm</span><span class="o">=</span><span class="n">B</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{}</span>
</pre></div>
</div>
<p>Just like that we can now run the asimmodule with any correctly configured
calculator for all the structures! We can even now run <code class="docutils literal notranslate"><span class="pre">calc_array</span></code> to
iterate getting the results using different calculators.</p>
</section>
<section id="make-the-asimmodule-use-any-structure">
<h2>4. Make the asimmodule use any structure<a class="headerlink" href="#make-the-asimmodule-use-any-structure" title="Link to this heading"></a></h2>
<p>The final change we will make is to parallelize over structures as below</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ase.build</span><span class="w"> </span><span class="kn">import</span> <span class="n">bulk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.eos</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_eos</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">connect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">asimtools.calculators</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_calc</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ase_eos</span><span class="p">(</span>
    <span class="n">image</span><span class="p">,</span>
    <span class="n">calc_id</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">load_calc</span><span class="p">(</span><span class="n">calc_id</span><span class="p">)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="s1">&#39;bulk.db&#39;</span><span class="p">)</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">get_atoms</span><span class="p">(</span><span class="o">**</span><span class="n">image</span><span class="p">)</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">calc</span>
    <span class="n">eos</span> <span class="o">=</span> <span class="n">calculate_eos</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>  <span class="c1"># find minimum</span>
    <span class="c1"># Do one more calculation at the minimu and write to database:</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span> <span class="o">*=</span> <span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_volume</span><span class="p">())</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">bm</span><span class="o">=</span><span class="n">B</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{}</span>
</pre></div>
</div>
<p>Easy-peasy. We now have an asimmodule that works with arbitrary environment,
arbitrary calculator and arbitrary input structure (Of course the simulation
will fail if we give a bad structure/calculator for example)</p>
</section>
<section id="final-cleanup">
<h2>5. Final cleanup<a class="headerlink" href="#final-cleanup" title="Link to this heading"></a></h2>
<p>We can do some final cleanup of the asimmodule so that it sends outputs to
<code class="docutils literal notranslate"><span class="pre">output.yaml</span></code> and logs some checkpoints. Additionally, any asimmodules added
to the repository will need clear syntax highlighting and documentation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.eos</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_eos</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">connect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">asimtools.calculators</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_calc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">asimtools.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_atoms</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ase_eos</span><span class="p">(</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">calc_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">db_file</span><span class="p">:</span> <span class="s1">&#39;bulk.db&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">load_calc</span><span class="p">(</span><span class="n">calc_id</span><span class="p">)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">get_atoms</span><span class="p">(</span><span class="o">**</span><span class="n">image</span><span class="p">)</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">calc</span>
    <span class="n">eos</span> <span class="o">=</span> <span class="n">calculate_eos</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>  <span class="c1"># find minimum</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Successfully fit EOS&#39;</span><span class="p">)</span>
    <span class="c1"># Do one more calculation at the minimu and write to database:</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span> <span class="o">*=</span> <span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_volume</span><span class="p">())</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
    <span class="n">db</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">bm</span><span class="o">=</span><span class="n">B</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">B</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
<p>To run this asimmodule on an arbitrary structure say Argon with say the
LennardJones calculator, in a slurm job we can now use the following input
files.</p>
<p>sim_input.yaml:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">asimmodule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/ase_eos.py</span>
<span class="nt">env_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch</span>
<span class="nt">workdir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">results</span>
<span class="nt">args</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span>
<span class="w">        </span><span class="nt">builder</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bulk</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ar</span>
<span class="w">    </span><span class="nt">calc_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lj_Ar</span>
</pre></div>
</div>
<p>calc_input.yaml:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">lj_Ar</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LennardJones</span>
<span class="w">    </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ase.calculators.lj</span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span>
<span class="w">        </span><span class="nt">sigma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.54</span>
<span class="w">        </span><span class="nt">epsilon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.00802236</span>
<span class="nt">emt</span><span class="p">:</span><span class="w"> </span><span class="c1">#This is not used if an LJ calculator is chosen</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EMT</span>
<span class="w">    </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ase.calculators.emt</span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</pre></div>
</div>
<p>env_input.yaml:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">batch</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span>
<span class="w">        </span><span class="nt">use_slurm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">interactive</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">slurm</span><span class="p">:</span>
<span class="w">        </span><span class="nt">flags</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-n 2</span>
<span class="w">        </span><span class="nt">precommands</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">source ~/.bashrc</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda activate asimtools</span>
<span class="nt">inline</span><span class="p">:</span><span class="w"> </span><span class="c1"># This is not used if env_id is batch</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span>
<span class="w">        </span><span class="nt">use_slurm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">        </span><span class="nt">interactive</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="running-multiple-simulations-in-a-workflow">
<h2>6. Running multiple simulations in a workflow<a class="headerlink" href="#running-multiple-simulations-in-a-workflow" title="Link to this heading"></a></h2>
<p>Going back to the original problem, we wanted to run the simulation of multiple
different elements with the EMT calculator. To achieve that in parallel, we can
nest the <code class="docutils literal notranslate"><span class="pre">ase_eos</span></code> asimmodule in a
<code class="xref py py-func docutils literal notranslate"><span class="pre">asimtools.asimmodules.workflows.sim_array.sim_array()</span></code> asimmodule as follows</p>
<p>sim_input.yaml:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">asimmodule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">workflows.sim_array</span>
<span class="nt">workdir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">results</span>
<span class="nt">args</span><span class="p">:</span>
<span class="w">    </span><span class="nt">key_sequence</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;args&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;image&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;name&#39;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">array_values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;Al&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Ni&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Cu&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Pd&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Ag&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Pt&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Au&#39;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">env_ids</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;batch&#39;</span>
<span class="w">    </span><span class="nt">template_sim_input</span><span class="p">:</span>
<span class="w">        </span><span class="nt">asimmodule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/ase_eos.py</span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span>
<span class="w">            </span><span class="nt">calc_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">emt</span>
<span class="w">            </span><span class="nt">image</span><span class="p">:</span>
<span class="w">                </span><span class="nt">builder</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bulk</span>
<span class="w">                </span><span class="nt">crystalstructure</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;fcc&#39;</span>
</pre></div>
</div>
<p>To make the asimmodule easier to access without having to use the full path, you
can set the environment variable</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ASIMTOOLS_ASIMMODULE_DIR=/path/to/my/asimmodule/dir/</span>
</pre></div>
</div>
<p>You can then move the <code class="docutils literal notranslate"><span class="pre">ase_eos.py</span></code> asimmodule to
<code class="docutils literal notranslate"><span class="pre">/path/to/my/asimmodule/dir/</span></code> i.e. the asimmodule directory. This allows you
to refer to asimmodules prepended with the asimmodule dir as below</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">asimmodule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">workflows.sim_array</span>
<span class="nt">workdir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">results</span>
<span class="nt">args</span><span class="p">:</span>
<span class="w">    </span><span class="nt">key_sequence</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;args&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;image&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;name&#39;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">array_values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;Al&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Ni&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Cu&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Pd&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Ag&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Pt&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Au&#39;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">env_ids</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;batch&#39;</span>
<span class="w">    </span><span class="nt">template_sim_input</span><span class="p">:</span>
<span class="w">        </span><span class="nt">asimmodule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ase_eos/ase_eos.py</span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span>
<span class="w">            </span><span class="nt">calc_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">emt</span>
<span class="w">            </span><span class="nt">image</span><span class="p">:</span>
<span class="w">                </span><span class="nt">builder</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bulk</span>
<span class="w">                </span><span class="nt">crystalstructure</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;fcc&#39;</span>
</pre></div>
</div>
<p>The above example loops over crystals for which ASE already has FCC lattice
parameters, but what if we want to loop over the species and corresponding
lattice parameters? We can either specify a list of <code class="docutils literal notranslate"><span class="pre">images</span></code> dictionaries as
<code class="docutils literal notranslate"><span class="pre">array_values</span></code> or use <code class="docutils literal notranslate"><span class="pre">secondary_array_values</span></code>. We can also explicitly tell
ASIMTools to include the array_values in the directory names in the standard
format (e.g. <code class="docutils literal notranslate"><span class="pre">id-0000__Al__</span></code>, <code class="docutils literal notranslate"><span class="pre">id-0001__Ni__</span></code> etc.).</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">asimmodule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">workflows.sim_array</span>
<span class="nt">workdir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">results</span>
<span class="nt">args</span><span class="p">:</span>
<span class="w">    </span><span class="nt">key_sequence</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;args&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;image&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;name&#39;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">array_values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;Al&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Ni&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Cu&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Pd&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Ag&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Pt&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;Au&#39;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">values</span>
<span class="w">    </span><span class="nt">secondary_key_sequences</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;args&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;image&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;a&#39;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">secondary_array_values</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">4.0479</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.524</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.6149</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.8907</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4.0853</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.9242</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4.0782</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">env_ids</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;batch&#39;</span>
<span class="w">    </span><span class="nt">template_sim_input</span><span class="p">:</span>
<span class="w">        </span><span class="nt">asimmodule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ase_eos/ase_eos.py</span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span>
<span class="w">            </span><span class="nt">calc_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">emt</span>
<span class="w">            </span><span class="nt">image</span><span class="p">:</span>
<span class="w">                </span><span class="nt">builder</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bulk</span>
<span class="w">                </span><span class="nt">crystalstructure</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;fcc&#39;</span>
</pre></div>
</div>
<p>This will perform the EOS calculation for each species with the corresponding
lattice parameter. That’s 7x5=35 calculations in parallel without touching code
or a job script!</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="usage.html" class="btn btn-neutral float-left" title="Running an Existing Asimmodule" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="workflows.html" class="btn btn-neutral float-right" title="Using built-in workflow tools" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Mgcini Keith Phuthi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>